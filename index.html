<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP 報表分析整合工具 (全方位篩選與自訂匯出標題版)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Chart.js for Dashboard Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px;}
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px;}
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .tab-inactive { color: #64748b; font-weight: 500; }
        .tab-inactive:hover { color: #475569; background: #f8fafc; }

        /* 防止 Excel 複製貼上時轉成科學記號的樣式 */
        .text-format { mso-number-format: "\@"; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const CHART_COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#64748b'];

        // SVG Icons
        const Icons = {
            Upload: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            FileText: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
            Download: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Trash2: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            BarChart3: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
            Filter: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            CheckCircle2: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>,
            Tag: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94 .94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></svg>,
            FileSpreadsheet: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>,
            LayoutDashboard: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
            Loader: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>,
            Calendar: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            Building: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><path d="M9 22v-4h6v4"></path><path d="M8 6h.01"></path><path d="M16 6h.01"></path><path d="M12 6h.01"></path><path d="M12 10h.01"></path><path d="M12 14h.01"></path><path d="M16 10h.01"></path><path d="M16 14h.01"></path><path d="M8 10h.01"></path><path d="M8 14h.01"></path></svg>,
            Search: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
            Ticket: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"></path></svg>,
            CreditCard: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="20" height="14" x="2" y="5" rx="2"></rect><line x1="2" y1="10" x2="22" y2="10"></line></svg>,
            User: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>,
            Globe: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
        };

        const { useState, useMemo, useEffect, useRef } = React;

        // Chart.js 獨立元件
        const SimpleChart = ({ type, data, options }) => {
            const canvasRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (chartInstance.current) chartInstance.current.destroy();
                if (canvasRef.current && data) {
                    const ctx = canvasRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: type,
                        data: data,
                        options: { responsive: true, maintainAspectRatio: false, ...options }
                    });
                }
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [type, data, options]);

            return <canvas ref={canvasRef} style={{ width: '100%', height: '100%' }}></canvas>;
        };

        // 載入進度條組件
        const LoadingOverlay = ({ loading }) => {
            if (!loading) return null;
            return (
                <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-96 text-center transform transition-all animate-in zoom-in-95 duration-200">
                        <Icons.Loader size={40} className="animate-spin text-blue-600 mx-auto mb-5" />
                        <h3 className="text-xl font-bold text-slate-800 mb-2">{loading.title}</h3>
                        <p className="text-sm text-slate-500 mb-5">{loading.subtitle || "請稍候，資料處理中..."}</p>
                        <div className="w-full bg-slate-100 rounded-full h-3 mb-2 overflow-hidden border border-slate-200">
                            <div className="bg-blue-500 h-full rounded-full transition-all duration-300 ease-out relative" style={{ width: `${Math.max(5, loading.progress)}%` }}>
                                <div className="absolute inset-0 bg-white/20 animate-pulse"></div>
                            </div>
                        </div>
                        <p className="text-sm font-semibold text-blue-600">{Math.round(loading.progress)}%</p>
                    </div>
                </div>
            );
        };

        const APP_TITLE = "ERP 報表分析整合工具";
        
        // 原始解析用欄位
        const HEADERS = [
            "TransactionID", "Venue", "VenueID", "Category", "ProductCode", 
            "Ref2", "Ref3", "FullTicketID", "Action", "Code", "UserTypeCode", 
            "TicketType", "Amount", "Discount", "NetAmount", "Currency", 
            "PaymentMethod", "Channel", "Extra1", "Extra2", "Status", "SourceFile"
        ];

        // 匯出時自訂欄位名稱的對應表
        const EXPORT_HEADER_MAP = {
            "FullTicketID": "ProuductCodeFull",
            "VenueID": "VenueCode",
            "UserTypeCode": "TicketTypeCode",
            "Extra1": "Remarks1",
            "Extra2": "Remarks2",
            "Status": "Done by"
        };

        // 暫停函式，用於釋放主執行緒，避免瀏覽器「無法回應」
        const yieldThread = () => new Promise(resolve => setTimeout(resolve, 0));

        function App() {
            const [isDragging, setIsDragging] = useState(false);
            const [processedData, setProcessedData] = useState([]);
            const [filesList, setFilesList] = useState([]);
            const [loading, setLoading] = useState(null);
            
            const [activeTab, setActiveTab] = useState('data');
            
            // 篩選器狀態 (增加4組新篩選)
            const [selectedCodes, setSelectedCodes] = useState(new Set()); 
            const [selectedProducts, setSelectedProducts] = useState(new Set()); 
            const [selectedMonths, setSelectedMonths] = useState(new Set()); 
            const [selectedVenues, setSelectedVenues] = useState(new Set());
            const [selectedTicketTypes, setSelectedTicketTypes] = useState(new Set());
            const [selectedPaymentMethods, setSelectedPaymentMethods] = useState(new Set());
            const [selectedStatuses, setSelectedStatuses] = useState(new Set()); // Status 即為 "Done by"
            const [selectedChannels, setSelectedChannels] = useState(new Set());
            
            // 搜尋狀態
            const [productSearchStr, setProductSearchStr] = useState("");

            // 智能提取日期函式
            const extractDate = (rowObj) => {
                let txId = rowObj["TransactionID"] || "";
                const txMatch = txId.match(/^(20[1-3]\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])/);
                if (txMatch) {
                    return { year: txMatch[1], month: `${txMatch[1]}-${txMatch[2]}`, full: `${txMatch[1]}-${txMatch[2]}-${txMatch[3]}` };
                }
                for (let key of Object.keys(rowObj)) {
                    let val = rowObj[key];
                    if (typeof val === 'string') {
                        let m1 = val.match(/^(20\d{2})[-/](0[1-9]|1[0-2])[-/](0[1-9]|[12]\d|3[01])/);
                        if (m1) return { year: m1[1], month: `${m1[1]}-${m1[2]}`, full: `${m1[1]}-${m1[2]}-${m1[3]}` };
                        
                        let m2 = val.match(/^(0[1-9]|[12]\d|3[01])[-/](0[1-9]|1[0-2])[-/](20\d{2})/);
                        if (m2) return { year: m2[3], month: `${m2[3]}-${m2[2]}`, full: `${m2[3]}-${m2[2]}-${m2[1]}` };
                    }
                }
                return { year: '未知', month: '未知', full: '未知' };
            };

            const handleFileUpload = async (e) => {
                const files = Array.from(e.target.files || e.dataTransfer.files);
                if (files.length === 0) return;

                const newFilesList = [...filesList];
                const newProcessedData = [...processedData];

                try {
                    for (let f = 0; f < files.length; f++) {
                        const file = files[f];
                        if (filesList.some(exist => exist.name === file.name)) continue;

                        setLoading({ title: "正在讀取檔案...", subtitle: `檔案：${file.name} (${f+1}/${files.length})`, progress: 0 });
                        await yieldThread();

                        const text = await readFileAsText(file);
                        
                        const lines = text.trim().split('\n');
                        if (lines.length < 2) continue;

                        const sampleLine = lines.length > 1 ? lines[1] : lines[0];
                        let delimiter = sampleLine.includes('|') ? '|' : '\t';
                        const startIndex = (lines[0].includes('202') && lines[0].length < 50) ? 1 : 0;
                        
                        const parsedRows = [];
                        const CHUNK_SIZE = 5000; 
                        
                        for (let i = startIndex; i < lines.length; i += CHUNK_SIZE) {
                            setLoading({ title: "正在解析數據...", subtitle: `處理進度：${i}/${lines.length} 行`, progress: (i / lines.length) * 100 });
                            await yieldThread();

                            const end = Math.min(i + CHUNK_SIZE, lines.length);
                            for (let j = i; j < end; j++) {
                                const line = lines[j].trim();
                                if (!line) continue;
                                const cols = line.split(delimiter).map(c => c.trim());
                                if (cols.length < 5) continue;

                                const rowObj = {};
                                for (let k = 0; k < HEADERS.length - 1; k++) {
                                    rowObj[HEADERS[k]] = cols[k] || "";
                                }
                                rowObj["SourceFile"] = file.name;
                                
                                const dateInfo = extractDate(rowObj);
                                rowObj["TxYear"] = dateInfo.year;
                                rowObj["TxMonth"] = dateInfo.month;
                                rowObj["TxDate"] = dateInfo.full;

                                const actionStr = (rowObj["Action"] || "").toLowerCase();
                                const statusStr = (rowObj["Status"] || "").toLowerCase();
                                const isReturn = actionStr.includes('return') || actionStr.includes('refund') || statusStr.includes('return') || statusStr.includes('refund');
                                
                                rowObj["isReturn"] = isReturn;

                                let netAmt = parseFloat(rowObj["NetAmount"]) || 0;
                                let amt = parseFloat(rowObj["Amount"]) || 0;
                                if (isReturn) {
                                    if (netAmt > 0) netAmt = -netAmt;
                                    if (amt > 0) amt = -amt;
                                    rowObj["NetAmount"] = netAmt.toString();
                                    rowObj["Amount"] = amt.toString();
                                }
                                rowObj["NetAmountNum"] = netAmt;

                                const origProdCodeStr = (rowObj["ProductCode"] || "").trim().toUpperCase();
                                const firstLetter = origProdCodeStr.charAt(0);
                                let mappedCode = "Others";
                                if (firstLetter === "S") {
                                    mappedCode = "HKPM (香港故宮)";
                                } else if (firstLetter === "P" || firstLetter === "Q") {
                                    mappedCode = "Performing Arts (表演藝術)";
                                } else if (firstLetter === "M") {
                                    mappedCode = "M+";
                                } else if (firstLetter === "D") {
                                    mappedCode = "Others";
                                } else if (origProdCodeStr !== "") {
                                    mappedCode = "Others";
                                }
                                rowObj["DashboardCode"] = mappedCode;

                                const origChannel = (rowObj["Channel"] || "").toLowerCase();
                                rowObj["DashboardChannel"] = (origChannel.includes("internet") || origChannel.includes("web") || origChannel.includes("online")) ? "Internet" : "Non online";

                                parsedRows.push(rowObj);
                            }
                        }

                        newFilesList.push({ name: file.name, size: file.size, rowCount: parsedRows.length });
                        newProcessedData.push(...parsedRows);
                    }
                    
                    setFilesList(newFilesList);
                    setProcessedData(newProcessedData);
                    
                    if (newProcessedData.length > 0) {
                        setLoading({ title: "完成！", subtitle: "即將顯示圖表", progress: 100 });
                        await new Promise(r => setTimeout(r, 400));
                        setActiveTab('dashboard');
                    }
                } catch (err) {
                    console.error(err);
                    alert("處理檔案時發生錯誤。");
                } finally {
                    setLoading(null);
                }
            };

            const readFileAsText = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsText(file);
                });
            };

            const uniqueOptions = useMemo(() => {
                const codes = new Set(), products = new Set(), months = new Set(), venues = new Set();
                const ticketTypes = new Set(), paymentMethods = new Set(), statuses = new Set(), channels = new Set();
                
                processedData.forEach(row => {
                    if(row.Code !== undefined) codes.add(row.Code);
                    if(row.ProductCode !== undefined) products.add(row.ProductCode);
                    if(row.TxMonth && row.TxMonth !== '未知') months.add(row.TxMonth);
                    if(row.DashboardCode !== undefined) venues.add(row.DashboardCode);
                    
                    if(row.TicketType !== undefined) ticketTypes.add(row.TicketType);
                    if(row.PaymentMethod !== undefined) paymentMethods.add(row.PaymentMethod);
                    if(row.Status !== undefined) statuses.add(row.Status);
                    if(row.Channel !== undefined) channels.add(row.Channel);
                });
                return {
                    codes: Array.from(codes).sort(),
                    products: Array.from(products).sort(),
                    months: Array.from(months).sort().reverse(),
                    venues: Array.from(venues).sort(),
                    ticketTypes: Array.from(ticketTypes).sort(),
                    paymentMethods: Array.from(paymentMethods).sort(),
                    statuses: Array.from(statuses).sort(),
                    channels: Array.from(channels).sort()
                };
            }, [processedData]);

            // Filter Product Codes based on Search Input
            const visibleProducts = useMemo(() => {
                if (!productSearchStr) return uniqueOptions.products;
                const lowerSearch = productSearchStr.toLowerCase();
                return uniqueOptions.products.filter(p => p.toLowerCase().includes(lowerSearch));
            }, [uniqueOptions.products, productSearchStr]);

            // 初始化選取所有選項
            useEffect(() => {
                if (uniqueOptions.codes.length > 0 && selectedCodes.size === 0) setSelectedCodes(new Set(uniqueOptions.codes));
                if (uniqueOptions.products.length > 0 && selectedProducts.size === 0) setSelectedProducts(new Set(uniqueOptions.products));
                if (uniqueOptions.months.length > 0 && selectedMonths.size === 0) setSelectedMonths(new Set(uniqueOptions.months));
                if (uniqueOptions.venues.length > 0 && selectedVenues.size === 0) setSelectedVenues(new Set(uniqueOptions.venues));
                if (uniqueOptions.ticketTypes.length > 0 && selectedTicketTypes.size === 0) setSelectedTicketTypes(new Set(uniqueOptions.ticketTypes));
                if (uniqueOptions.paymentMethods.length > 0 && selectedPaymentMethods.size === 0) setSelectedPaymentMethods(new Set(uniqueOptions.paymentMethods));
                if (uniqueOptions.statuses.length > 0 && selectedStatuses.size === 0) setSelectedStatuses(new Set(uniqueOptions.statuses));
                if (uniqueOptions.channels.length > 0 && selectedChannels.size === 0) setSelectedChannels(new Set(uniqueOptions.channels));
            }, [uniqueOptions]);

            const toggleSet = (set, val, setter) => {
                const newSet = new Set(set);
                if (newSet.has(val)) newSet.delete(val); else newSet.add(val);
                setter(newSet);
            };

            const filteredData = useMemo(() => {
                if (processedData.length === 0) return [];
                return processedData.filter(row => 
                    selectedCodes.has(row.Code) && 
                    selectedProducts.has(row.ProductCode) &&
                    (row.TxMonth === '未知' || selectedMonths.has(row.TxMonth)) &&
                    selectedVenues.has(row.DashboardCode) &&
                    selectedTicketTypes.has(row.TicketType) &&
                    selectedPaymentMethods.has(row.PaymentMethod) &&
                    selectedStatuses.has(row.Status) &&
                    selectedChannels.has(row.Channel)
                );
            }, [processedData, selectedCodes, selectedProducts, selectedMonths, selectedVenues, selectedTicketTypes, selectedPaymentMethods, selectedStatuses, selectedChannels]);

            const handleDragOver = (e) => { e.preventDefault(); setIsDragging(true); };
            const handleDragLeave = () => { setIsDragging(false); };
            const handleDrop = (e) => { e.preventDefault(); setIsDragging(false); handleFileUpload(e); };
            
            const clearAll = () => { 
                setFilesList([]); setProcessedData([]); 
                setSelectedCodes(new Set()); setSelectedProducts(new Set()); 
                setSelectedMonths(new Set()); setSelectedVenues(new Set());
                setSelectedTicketTypes(new Set()); setSelectedPaymentMethods(new Set());
                setSelectedStatuses(new Set()); setSelectedChannels(new Set());
                setProductSearchStr("");
                setActiveTab('data');
            };

            const dashboardStats = useMemo(() => {
                if (filteredData.length === 0) return null;
                const codeMap = {}, channelMap = {}, productMap = {};
                let totalRevenue = 0, totalTx = 0, totalTickets = 0;

                filteredData.forEach(row => {
                    const rev = row.NetAmountNum;
                    const isReturn = row.isReturn;
                    const ticketCountChange = isReturn ? -1 : 1; 

                    totalRevenue += rev; 
                    totalTx += 1;
                    totalTickets += ticketCountChange;

                    if(!codeMap[row.DashboardCode]) codeMap[row.DashboardCode] = { name: row.DashboardCode, value: 0 };
                    codeMap[row.DashboardCode].value += rev;

                    if(!channelMap[row.DashboardChannel]) channelMap[row.DashboardChannel] = { name: row.DashboardChannel, value: 0 };
                    channelMap[row.DashboardChannel].value += rev;

                    const prodCode = row.ProductCode || "Unknown";
                    if(!productMap[prodCode]) productMap[prodCode] = { name: prodCode, count: 0 };
                    productMap[prodCode].count += ticketCountChange;
                });

                return { 
                    codeData: Object.values(codeMap).sort((a,b)=>b.value - a.value), 
                    channelData: Object.values(channelMap).sort((a,b)=>b.value - a.value), 
                    productData: Object.values(productMap).sort((a,b)=>b.count - a.count), 
                    totalRevenue, totalTx, totalTickets
                };
            }, [filteredData]);

            const chartData = useMemo(() => {
                if (!dashboardStats) return null;
                const pieTooltipOptions = { callbacks: { label: (ctx) => `HK$ ${ctx.parsed.y !== undefined ? ctx.parsed.y.toLocaleString() : ctx.parsed.toLocaleString()}` } };
                const pieOptions = { plugins: { tooltip: pieTooltipOptions, legend: { position: 'bottom' } } };

                return {
                    codePie: {
                        data: { labels: dashboardStats.codeData.map(d => d.name), datasets: [{ data: dashboardStats.codeData.map(d => d.value), backgroundColor: CHART_COLORS, borderWidth: 1 }] },
                        options: pieOptions
                    },
                    channelPie: {
                        data: { labels: dashboardStats.channelData.map(d => d.name), datasets: [{ data: dashboardStats.channelData.map(d => d.value), backgroundColor: ['#3b82f6', '#f59e0b'], borderWidth: 1 }] },
                        options: pieOptions
                    },
                    productBar: {
                        data: { 
                            labels: dashboardStats.productData.slice(0, 15).map(d => d.name), 
                            datasets: [{ 
                                label: '門票數量 (張)', 
                                data: dashboardStats.productData.slice(0, 15).map(d => d.count), 
                                backgroundColor: '#10b981', 
                                borderRadius: 4 
                            }] 
                        },
                        options: { 
                            plugins: { 
                                tooltip: { callbacks: { label: (ctx) => ` 門票數: ${ctx.parsed.y} 張` } },
                                legend: { display: false } 
                            }, 
                            scales: { 
                                x: { ticks: { maxRotation: 45, minRotation: 45, font: {size: 11} } },
                                y: { ticks: { callback: (v) => v + ' 張', stepSize: 1 } } 
                            } 
                        }
                    }
                };
            }, [dashboardStats]);

            const downloadCSV = async () => {
                if (filteredData.length === 0) return;
                
                setLoading({ title: "準備生成 CSV", subtitle: "計算資料量中...", progress: 10 });
                await yieldThread();

                // 使用匯出對應表建立 CSV 第一行標題
                const csvHeaderStr = HEADERS.map(h => EXPORT_HEADER_MAP[h] || h).join(",") + "\n";
                let csvRows = "";
                
                const CHUNK = 5000;
                for (let i = 0; i < filteredData.length; i += CHUNK) {
                    setLoading({ title: "正在寫入 CSV", subtitle: `處理進度：${i}/${filteredData.length}`, progress: 10 + (i / filteredData.length) * 80 });
                    await yieldThread();
                    
                    const end = Math.min(i + CHUNK, filteredData.length);
                    const chunkArr = [];
                    for(let j = i; j < end; j++) {
                        const row = filteredData[j];
                        chunkArr.push(HEADERS.map(h => {
                            let val = row[h] ? String(row[h]) : "";
                            if (h === "TransactionID") val = `="${val}"`;
                            else if (val.includes(",")) val = `"${val}"`;
                            return val;
                        }).join(","));
                    }
                    csvRows += chunkArr.join("\n") + "\n";
                }

                setLoading({ title: "打包檔案中", subtitle: "即將觸發下載", progress: 95 });
                await yieldThread();

                const blob = new Blob(["\uFEFF" + csvHeaderStr + csvRows], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url; link.setAttribute("download", `Filtered_Report_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link); link.click(); document.body.removeChild(link);

                setLoading({ title: "完成！", progress: 100 });
                await new Promise(r => setTimeout(r, 400));
                setLoading(null);
            };

            const downloadExcel = async () => {
                if (filteredData.length === 0) return;
                
                setLoading({ title: "準備 Excel 數據...", subtitle: "套用自訂欄位名稱", progress: 15 });
                await yieldThread();
                
                const exportData = [];
                const CHUNK = 10000;
                for (let i = 0; i < filteredData.length; i += CHUNK) {
                    setLoading({ title: "複製資料中...", subtitle: `進度: ${i}/${filteredData.length}`, progress: 15 + (i/filteredData.length)*20 });
                    await yieldThread();
                    const end = Math.min(i + CHUNK, filteredData.length);
                    for (let j = i; j < end; j++) {
                        const newRow = {};
                        HEADERS.forEach(h => { 
                            // 根據對應表轉換欄位名稱，若沒有定義則使用原始名稱
                            const exportKeyName = EXPORT_HEADER_MAP[h] || h;
                            newRow[exportKeyName] = filteredData[j][h] ? String(filteredData[j][h]) : ""; 
                        });
                        exportData.push(newRow);
                    }
                }

                setLoading({ title: "正在轉換為試算表格式...", subtitle: "利用 SheetJS 建立表格", progress: 40 });
                await yieldThread();

                const worksheet = XLSX.utils.json_to_sheet(exportData);
                
                setLoading({ title: "強制轉換文字格式...", subtitle: "確保 TransactionID 顯示正確", progress: 60 });
                await yieldThread();

                if (worksheet['!ref']) {
                    const range = XLSX.utils.decode_range(worksheet['!ref']);
                    // 由於我們匯出的順序沒變，TransactionID 依然是第 0 欄
                    let transColIndex = 0; 
                    for(let R = range.s.r + 1; R <= range.e.r; ++R) {
                        if (R % 5000 === 0) {
                            setLoading({ title: "優化儲存格格式...", subtitle: `行數: ${R}/${range.e.r}`, progress: 60 + (R/range.e.r)*20 });
                            await yieldThread();
                        }
                        const cellAddress = XLSX.utils.encode_cell({r: R, c: transColIndex});
                        if(worksheet[cellAddress]) worksheet[cellAddress].t = 's';
                    }
                }

                setLoading({ title: "正在打包 Excel 檔案...", subtitle: "由於 Excel 格式複雜，大檔案需時數十秒，請耐心等候", progress: 85 });
                await yieldThread();

                await new Promise(r => setTimeout(r, 100));

                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Data");
                XLSX.writeFile(workbook, `Filtered_Report_${new Date().toISOString().slice(0,10)}.xlsx`);

                setLoading({ title: "匯出完成！", subtitle: "請檢查下載資料夾", progress: 100 });
                await new Promise(r => setTimeout(r, 600));
                setLoading(null);
            };

            return (
                <div className="min-h-screen p-6 font-sans relative">
                    <LoadingOverlay loading={loading} />
                    
                    <div className="max-w-7xl mx-auto space-y-6">
                        {/* Header & Controls */}
                        <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <div>
                                <h1 className="text-2xl font-bold text-slate-900">{APP_TITLE}</h1>
                                <p className="text-sm text-slate-500 mt-1">。</p>
                            </div>
                            {processedData.length > 0 && (
                                <div className="flex flex-wrap gap-3">
                                    <button onClick={clearAll} className="flex items-center gap-2 px-4 py-2 text-sm text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors">
                                        <Icons.Trash2 size={16} /> 清除檔案
                                    </button>
                                    <button onClick={downloadCSV} disabled={filteredData.length === 0} className="flex items-center gap-2 px-4 py-2 text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
                                        <Icons.Download size={16} /> 匯出 CSV
                                    </button>
                                    <button onClick={downloadExcel} disabled={filteredData.length === 0} className="flex items-center gap-2 px-5 py-2 text-sm bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg shadow-sm transition-all active:scale-95">
                                        <Icons.FileSpreadsheet size={16} /> 匯出 Excel
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* Upload Zone */}
                        {filesList.length === 0 && (
                            <div onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={handleDrop} className={`relative border-2 border-dashed rounded-xl p-16 text-center transition-all cursor-pointer ${isDragging ? 'border-blue-500 bg-blue-50' : 'border-slate-300 bg-white hover:border-blue-400 hover:bg-slate-50'}`}>
                                <input type="file" multiple accept=".txt,.csv" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onChange={handleFileUpload} />
                                <div className="flex flex-col items-center gap-4 pointer-events-none">
                                    <div className={`p-4 rounded-full ${isDragging ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-500'}`}>
                                        <Icons.Upload size={40} />
                                    </div>
                                    <div>
                                        <h3 className="text-xl font-semibold text-slate-700">點擊選擇檔案 或 將檔案拖曳至此</h3>
                                        <p className="text-sm text-slate-500 mt-2">支援 .txt 或 .csv 格式。大檔案讀取時將顯示進度條並防止瀏覽器無回應。</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Main Interface */}
                        {processedData.length > 0 && (
                            <div className="space-y-6">
                                {/* Tab Navigation */}
                                <div className="flex border-b border-slate-200">
                                    <button onClick={() => setActiveTab('dashboard')} className={`flex items-center gap-2 px-6 py-3 text-sm transition-colors ${activeTab === 'dashboard' ? 'tab-active' : 'tab-inactive'}`}>
                                        <Icons.LayoutDashboard size={18}/> 數據分析看板
                                    </button>
                                    <button onClick={() => setActiveTab('data')} className={`flex items-center gap-2 px-6 py-3 text-sm transition-colors ${activeTab === 'data' ? 'tab-active' : 'tab-inactive'}`}>
                                        <Icons.Filter size={18}/> 資料篩選與預覽
                                    </button>
                                </div>

                                {/* Tab: Dashboard */}
                                {activeTab === 'dashboard' && dashboardStats && chartData && (
                                    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-2">
                                        {/* 文字摘要區塊 */}
                                        <div className="bg-blue-50/50 p-6 rounded-xl border border-blue-100">
                                            <h3 className="font-bold text-lg text-blue-900 mb-4 flex items-center gap-2">
                                                <Icons.BarChart3 size={20} className="text-blue-600"/> 數據洞察摘要 (根據目前篩選)
                                            </h3>
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                                <div>
                                                    <div className="text-sm text-blue-600/80 mb-1">總淨銷售額 (已扣退款)</div>
                                                    <div className="text-2xl font-bold text-blue-900">${dashboardStats.totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                                </div>
                                                <div>
                                                    <div className="text-sm text-blue-600/80 mb-1">最高貢獻機構</div>
                                                    <div className="text-xl font-bold text-blue-900">{dashboardStats.codeData[0]?.name || 'N/A'}</div>
                                                    <div className="text-xs text-blue-700/70 mt-1">${dashboardStats.codeData[0]?.value.toLocaleString(undefined, {minimumFractionDigits: 0})}</div>
                                                </div>
                                                <div>
                                                    <div className="text-sm text-blue-600/80 mb-1">最暢銷 Product Code</div>
                                                    <div className="text-xl font-bold text-blue-900 truncate" title={dashboardStats.productData[0]?.name}>{dashboardStats.productData[0]?.name || 'N/A'}</div>
                                                    <div className="text-xs text-blue-700/70 mt-1">售出 {dashboardStats.productData[0]?.count.toLocaleString() || 0} 張</div>
                                                </div>
                                                <div>
                                                    <div className="text-sm text-blue-600/80 mb-1">網路銷售佔比 (Internet)</div>
                                                    <div className="text-2xl font-bold text-blue-900">
                                                        {dashboardStats.channelData.find(c => c.name === 'Internet') 
                                                            ? ((dashboardStats.channelData.find(c => c.name === 'Internet').value / dashboardStats.totalRevenue) * 100).toFixed(1) + '%' : '0%'}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* 圖表區塊 1 */}
                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col items-center">
                                                <h3 className="font-semibold text-slate-700 mb-4">各機構銷售佔比 (HKPM / PA / M+ ...)</h3>
                                                <div className="w-full h-[300px] relative"><SimpleChart type="pie" data={chartData.codePie.data} options={chartData.codePie.options} /></div>
                                            </div>
                                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col items-center">
                                                <h3 className="font-semibold text-slate-700 mb-4">銷售通路佔比 (Internet vs Non online)</h3>
                                                <div className="w-full h-[300px] relative"><SimpleChart type="pie" data={chartData.channelPie.data} options={chartData.channelPie.options} /></div>
                                            </div>
                                        </div>

                                        {/* 圖表區塊 2 (各 Product Code 門票數量分析) */}
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                            <h3 className="font-semibold text-slate-700 mb-6 flex items-center gap-2">
                                                <Icons.Tag size={20} className="text-emerald-500" />
                                                各 Product Code 門票數量分析 (Top 15)
                                            </h3>
                                            <div className="w-full h-[400px] relative"><SimpleChart type="bar" data={chartData.productBar.data} options={chartData.productBar.options} /></div>
                                        </div>
                                    </div>
                                )}

                                {/* Tab: Data Filter & Preview */}
                                {activeTab === 'data' && (
                                    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-2">
                                        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                                            <div className="flex items-center gap-2 text-slate-700 font-semibold border-b pb-3 mb-4">
                                                <Icons.Filter size={20} className="text-blue-600" />
                                                <span>資料篩選器 (篩選結果將同步影響看板及匯出)</span>
                                            </div>
                                            
                                            {/* 將原本的 grid-cols-4 改為兩行排版，共容納8個篩選器 */}
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                                
                                                {/* 1. Date Filter */}
                                                <div>
                                                    <div className="flex justify-between items-center mb-2">
                                                        <div className="flex items-center gap-1">
                                                            <Icons.Calendar size={16} className="text-slate-400"/>
                                                            <span className="text-sm font-medium text-slate-600">交易月份 (Year/Month)</span>
                                                        </div>
                                                        <div className="text-xs space-x-2">
                                                            <button onClick={() => setSelectedMonths(new Set(uniqueOptions.months))} className="text-blue-600 hover:underline">全選</button>
                                                            <button onClick={() => setSelectedMonths(new Set())} className="text-slate-400 hover:underline">清除</button>
                                                        </div>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto custom-scrollbar p-1 border border-slate-100 rounded bg-slate-50">
                                                        {uniqueOptions.months.length > 0 ? uniqueOptions.months.map(m => (
                                                            <button key={m} onClick={() => toggleSet(selectedMonths, m, setSelectedMonths)} 
                                                                className={`px-3 py-1 rounded text-xs border transition-all ${selectedMonths.has(m) ? 'bg-emerald-100 text-emerald-700 border-emerald-300 font-medium' : 'bg-white text-slate-500 border-slate-200 hover:border-emerald-300'}`}>
                                                                {m || "(空白)"}
                                                            </button>
                                                        )) : <span className="text-xs text-slate-400 p-1">無資料</span>}
                                                    </div>
                                                </div>

                                                {/* 2. Venue/Org Filter */}
                                                <div>
                                                    <div className="flex justify-between items-center mb-2">
                                                        <div className="flex items-center gap-1">
                                                            <Icons.Building size={16} className="text-slate-400"/>
                                                            <span className="text-sm font-medium text-slate-600">機構場地 (首字母)</span>
                                                        </div>
                                                        <div className="text-xs space-x-2">
                                                            <button onClick={() => setSelectedVenues(new Set(uniqueOptions.venues))} className="text-blue-600 hover:underline">全選</button>
                                                            <button onClick={() => setSelectedVenues(new Set())} className="text-slate-400 hover:underline">清除</button>
                                                        </div>
                                                    </div>
                                                    <div className="flex flex-col gap-2 max-h-40 overflow-y-auto custom-scrollbar p-1">
                                                        {uniqueOptions.venues.map(v => (
                                                            <button key={v} onClick={() => toggleSet(selectedVenues, v, setSelectedVenues)} 
                                                                className={`flex items-center gap-2 px-3 py-1.5 rounded text-left text-sm transition-all border ${selectedVenues.has(v) ? 'bg-amber-500 border-amber-500 text-white shadow-sm' : 'bg-white border-slate-200 text-slate-600 hover:border-amber-300 hover:text-amber-600'}`}>
                                                                {selectedVenues.has(v) ? <Icons.CheckCircle2 size={16} /> : <div className="w-4"></div>} {v || "(空白)"}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>

                                                {/* 3. Code Filter */}
                                                <div>
                                                    <div className="flex justify-between items-center mb-2">
                                                        <span className="text-sm font-medium text-slate-600">Transaction Code</span>
                                                        <div className="text-xs space-x-2">
                                                            <button onClick={() => setSelectedCodes(new Set(uniqueOptions.codes))} className="text-blue-600 hover:underline">全選</button>
                                                            <button onClick={() => setSelectedCodes(new Set())} className="text-slate-400 hover:underline">清除</button>
                                                        </div>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto custom-scrollbar p-1 border border-slate-100 rounded bg-slate-50">
                                                        {uniqueOptions.codes.map(code => (
                                                            <button key={code} onClick={() => toggleSet(selectedCodes, code, setSelectedCodes)} 
                                                                className={`flex items-center gap-2 px-3 py-1 rounded text-xs border transition-all ${selectedCodes.has(code) ? 'bg-blue-600 border-blue-600 text-white shadow-sm' : 'bg-white border-slate-200 text-slate-600 hover:border-blue-300 hover:text-blue-600'}`}>
                                                                {code || "(空白)"}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>

                                                {/* 4. Product Code Filter WITH SEARCH */}
                                                <div>
                                                    <div className="flex flex-col mb-2 gap-2">
                                                        <div className="flex justify-between items-center">
                                                            <div className="flex items-center gap-1">
                                                                <Icons.Tag size={16} className="text-slate-400"/>
                                                                <span className="text-sm font-medium text-slate-600">Product Code</span>
                                                            </div>
                                                            <div className="text-xs space-x-2">
                                                                <button onClick={() => setSelectedProducts(new Set(visibleProducts))} className="text-blue-600 hover:underline" title="全選下方過濾出的選項">選取顯示</button>
                                                                <button onClick={() => { setSelectedProducts(new Set()); setProductSearchStr(""); }} className="text-slate-400 hover:underline">清除</button>
                                                            </div>
                                                        </div>
                                                        <div className="relative">
                                                            <div className="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                                                <Icons.Search size={14} className="text-slate-400" />
                                                            </div>
                                                            <input 
                                                                type="text" 
                                                                placeholder="搜尋 (如 MBB)..." 
                                                                value={productSearchStr}
                                                                onChange={(e) => setProductSearchStr(e.target.value)}
                                                                className="w-full pl-8 pr-3 py-1.5 text-xs border border-slate-300 rounded focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                                            />
                                                        </div>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2 max-h-[105px] overflow-y-auto custom-scrollbar p-1 border border-slate-100 rounded bg-slate-50">
                                                        {visibleProducts.length > 0 ? visibleProducts.map(p => (
                                                            <button key={p} onClick={() => toggleSet(selectedProducts, p, setSelectedProducts)} 
                                                                className={`px-3 py-1 rounded text-xs border transition-all ${selectedProducts.has(p) ? 'bg-indigo-100 text-indigo-700 border-indigo-300 font-medium' : 'bg-white text-slate-500 border-slate-200 hover:border-indigo-300'}`}>
                                                                {p || "(空白)"}
                                                            </button>
                                                        )) : <span className="text-xs text-slate-400 w-full text-center py-2">查無相關</span>}
                                                    </div>
                                                </div>

                                                {/* 5. Ticket Type Filter (新增) */}
                                                <div>
                                                    <div className="flex justify-between items-center mb-2">
                                                        <div className="flex items-center gap-1">
                                                            <Icons.Ticket size={16} className="text-slate-400"/>
                                                            <span className="text-sm font-medium text-slate-600">Ticket Type</span>
                                                        </div>
                                                        <div className="text-xs space-x-2">
                                                            <button onClick={() => setSelectedTicketTypes(new Set(uniqueOptions.ticketTypes))} className="text-blue-600 hover:underline">全選</button>
                                                            <button onClick={() => setSelectedTicketTypes(new Set())} className="text-slate-400 hover:underline">清除</button>
                                                        </div>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto custom-scrollbar p-1 border border-slate-100 rounded bg-slate-50">
                                                        {uniqueOptions.ticketTypes.length > 0 ? uniqueOptions.ticketTypes.map(item => (
                                                            <button key={item} onClick={() => toggleSet(selectedTicketTypes, item, setSelectedTicketTypes)} 
                                                                className={`px-3 py-1 rounded text-xs border transition-all ${selectedTicketTypes.has(item) ? 'bg-teal-100 text-teal-800 border-teal-300 font-medium' : 'bg-white text-slate-500 border-slate-200 hover:border-teal-300'}`}>
                                                                {item || "(空白)"}
                                                            </button>
                                                        )) : <span className="text-xs text-slate-400 p-1">無資料</span>}
                                                    </div>
                                                </div>

                                                {/* 6. Payment Method Filter (新增) */}
                                                <div>
                                                    <div className="flex justify-between items-center mb-2">
                                                        <div className="flex items-center gap-1">
                                                            <Icons.CreditCard size={16} className="text-slate-400"/>
                                                            <span className="text-sm font-medium text-slate-600">Payment Method</span>
                                                        </div>
                                                        <div className="text-xs space-x-2">
                                                            <button onClick={() => setSelectedPaymentMethods(new Set(uniqueOptions.paymentMethods))} className="text-blue-600 hover:underline">全選</button>
                                                            <button onClick={() => setSelectedPaymentMethods(new Set())} className="text-slate-400 hover:underline">清除</button>
                                                        </div>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto custom-scrollbar p-1 border border-slate-100 rounded bg-slate-50">
                                                        {uniqueOptions.paymentMethods.length > 0 ? uniqueOptions.paymentMethods.map(item => (
                                                            <button key={item} onClick={() => toggleSet(selectedPaymentMethods, item, setSelectedPaymentMethods)} 
                                                                className={`px-3 py-1 rounded text-xs border transition-all ${selectedPaymentMethods.has(item) ? 'bg-purple-100 text-purple-800 border-purple-300 font-medium' : 'bg-white text-slate-500 border-slate-200 hover:border-purple-300'}`}>
                                                                {item || "(空白)"}
                                                            </button>
                                                        )) : <span className="text-xs text-slate-400 p-1">無資料</span>}
                                                    </div>
                                                </div>

                                                {/* 7. Done By (Status) Filter (新增) */}
                                                <div>
                                                    <div className="flex justify-between items-center mb-2">
                                                        <div className="flex items-center gap-1">
                                                            <Icons.User size={16} className="text-slate-400"/>
                                                            <span className="text-sm font-medium text-slate-600">Done by (Status)</span>
                                                        </div>
                                                        <div className="text-xs space-x-2">
                                                            <button onClick={() => setSelectedStatuses(new Set(uniqueOptions.statuses))} className="text-blue-600 hover:underline">全選</button>
                                                            <button onClick={() => setSelectedStatuses(new Set())} className="text-slate-400 hover:underline">清除</button>
                                                        </div>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto custom-scrollbar p-1 border border-slate-100 rounded bg-slate-50">
                                                        {uniqueOptions.statuses.length > 0 ? uniqueOptions.statuses.map(item => (
                                                            <button key={item} onClick={() => toggleSet(selectedStatuses, item, setSelectedStatuses)} 
                                                                className={`px-3 py-1 rounded text-xs border transition-all ${selectedStatuses.has(item) ? 'bg-rose-100 text-rose-800 border-rose-300 font-medium' : 'bg-white text-slate-500 border-slate-200 hover:border-rose-300'}`}>
                                                                {item || "(空白)"}
                                                            </button>
                                                        )) : <span className="text-xs text-slate-400 p-1">無資料</span>}
                                                    </div>
                                                </div>

                                                {/* 8. Channel Filter (新增) */}
                                                <div>
                                                    <div className="flex justify-between items-center mb-2">
                                                        <div className="flex items-center gap-1">
                                                            <Icons.Globe size={16} className="text-slate-400"/>
                                                            <span className="text-sm font-medium text-slate-600">Channel</span>
                                                        </div>
                                                        <div className="text-xs space-x-2">
                                                            <button onClick={() => setSelectedChannels(new Set(uniqueOptions.channels))} className="text-blue-600 hover:underline">全選</button>
                                                            <button onClick={() => setSelectedChannels(new Set())} className="text-slate-400 hover:underline">清除</button>
                                                        </div>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto custom-scrollbar p-1 border border-slate-100 rounded bg-slate-50">
                                                        {uniqueOptions.channels.length > 0 ? uniqueOptions.channels.map(item => (
                                                            <button key={item} onClick={() => toggleSet(selectedChannels, item, setSelectedChannels)} 
                                                                className={`px-3 py-1 rounded text-xs border transition-all ${selectedChannels.has(item) ? 'bg-sky-100 text-sky-800 border-sky-300 font-medium' : 'bg-white text-slate-500 border-slate-200 hover:border-sky-300'}`}>
                                                                {item || "(空白)"}
                                                            </button>
                                                        )) : <span className="text-xs text-slate-400 p-1">無資料</span>}
                                                    </div>
                                                </div>
                                                
                                            </div>
                                        </div>

                                        {/* Table Preview */}
                                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                            <div className="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                                <h3 className="font-semibold text-slate-700">篩選資料預覽 (前 50 筆)</h3>
                                                <span className="text-sm text-slate-500">當前篩選共 {filteredData.length.toLocaleString()} 筆</span>
                                            </div>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm text-left text-slate-500">
                                                    <thead className="text-xs text-slate-700 uppercase bg-slate-50">
                                                        <tr>{["日期", "TransactionID", "Venue", "Code", "ProductCode", "TicketType", "PaymentMethod", "Amount(HKD)", "Channel", "Done by"].map(h => (<th key={h} className="px-6 py-3 whitespace-nowrap">{h}</th>))}</tr>
                                                    </thead>
                                                    <tbody>
                                                        {filteredData.slice(0, 50).map((row, idx) => {
                                                            const isNegative = row.NetAmountNum < 0;
                                                            return (
                                                                <tr key={idx} className={`bg-white border-b hover:bg-slate-50 ${isNegative ? 'bg-red-50/30' : ''}`}>
                                                                    <td className="px-6 py-2 whitespace-nowrap text-xs text-slate-400">{row.TxDate}</td>
                                                                    <td className="px-6 py-2 font-mono text-xs text-slate-800 text-format whitespace-nowrap">{String(row.TransactionID)}</td>
                                                                    <td className="px-6 py-2 whitespace-nowrap">{row.Venue}</td>
                                                                    <td className="px-6 py-2 whitespace-nowrap font-bold text-blue-600">{row.Code}</td>
                                                                    <td className="px-6 py-2 whitespace-nowrap font-mono text-xs text-indigo-600 bg-indigo-50 px-2 rounded w-fit">{row.ProductCode}</td>
                                                                    <td className="px-6 py-2 whitespace-nowrap text-xs">{row.TicketType}</td>
                                                                    <td className="px-6 py-2 whitespace-nowrap text-xs">{row.PaymentMethod}</td>
                                                                    <td className={`px-6 py-2 font-medium ${isNegative ? 'text-red-600' : 'text-slate-900'}`}>{row.NetAmount}</td>
                                                                    <td className="px-6 py-2"><span className="px-2 py-1 bg-slate-100 rounded text-xs">{row.Channel}</span></td>
                                                                    <td className="px-6 py-2 whitespace-nowrap text-xs">{row.Status}</td>
                                                                </tr>
                                                            )
                                                        })}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div className="px-6 py-3 bg-slate-50 text-xs text-center text-slate-400 border-t border-slate-100">
                                                僅顯示篩選後的前 50 筆，請使用上方「匯出 Excel / CSV」以取得完整資料。
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
